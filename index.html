<!DOCTYPE html>
<html>
<head>
  <meta charset="utf-8">
  <meta name="viewport" content="width=device-width, initial-scale=1, maximum-scale=1, user-scalable=0">
  <title>LIFF GAS Test App</title>
  <script src="https://static.line-scdn.net/liff/edge/2/sdk.js"></script>
</head>
<body>
  <h1>LIFF GAS Test</h1>
  <p id="gasResult">GASからのメッセージ:</p>
  <p>ユーザー名: <span id="userName">未取得</span></p>
  <p>ユーザーID: <span id="userId">未取得</span></p>
  <p>プロフィール画像: <img id="userPicture" width="50" height="50"></p>

  <script>
    async function initializeLiff() {
      try {
        // LIFF IDは既に設定済みなので、そのまま利用します
        await liff.init({ liffId: "2007507724-jxmBZwP0" });
        if (!liff.isLoggedIn()) {
          liff.login();
        } else {
          // ログイン済みであればプロフィールを取得してGASに送信
          await sendProfileToGas();
        }
      } catch (e) {
        console.error("LIFF initialization failed", e);
        document.getElementById('gasResult').textContent = 'LIFF初期化エラー: ' + e.message;
      }
    }

    async function sendProfileToGas() {
      // GASのWebアプリURLは既に設定済みなので、そのまま利用します
      const gasUrl = "https://script.google.com/macros/s/AKfycbzHbfp1dpRj_0dwa9PE4aMwBIitMBx_-c4bKSHJc87XxPf_zBkO1ZATfs3ghoVU243p/exec";
      const gasResultElement = document.getElementById('gasResult');
      const userNameElement = document.getElementById('userName');
      const userIdElement = document.getElementById('userId');
      const userPictureElement = document.getElementById('userPicture');

      try {
        // LIFFからユーザープロフィールを取得
        const profile = await liff.getProfile();
        const displayName = profile.displayName;
        const userId = profile.userId;
        const pictureUrl = profile.pictureUrl;

        // ページにユーザー情報を表示
        userNameElement.textContent = displayName;
        userIdElement.textContent = userId;
        if (pictureUrl) {
            userPictureElement.src = pictureUrl;
            userPictureElement.alt = "プロフィール画像"; // 画像が読み込めなかった場合の代替テキスト
        } else {
            userPictureElement.alt = "画像なし";
        }

        // GASに送信するデータを作成
        const dataToSend = {
          type: "profileData", // GAS側で何のデータか識別できるようにする（任意）
          displayName: displayName,
          userId: userId,
          pictureUrl: pictureUrl
        };

        // GASへPOSTリクエストを送信
        const response = await fetch(gasUrl, {
          method: 'POST', // POSTメソッドを指定
          headers: {
            'Content-Type': 'application/json' // JSON形式で送信することを明示
          },
          body: JSON.stringify(dataToSend) // オブジェクトをJSON文字列に変換して送信
        });

        if (!response.ok) {
          throw new Error(`HTTP error! status: ${response.status} - ${response.statusText}`);
        }
        const gasResponseText = await response.text();
        gasResultElement.textContent = 'GASからのメッセージ: ' + gasResponseText;

      } catch (e) {
        console.error("Failed to send profile to GAS", e);
        gasResultElement.textContent = 'GASへのデータ送信エラー: ' + e.message;
        // エラー時も可能な限りユーザー情報を表示できるようにする
        // liff.getProfile()は同期的に呼べないので、try-catchで囲む
        try {
            const currentProfile = liff.getProfile(); // エラー発生時でも情報が取得できる場合がある
            userNameElement.textContent = currentProfile.displayName || '取得失敗';
            userIdElement.textContent = currentProfile.userId || '取得失敗';
            if (currentProfile.pictureUrl) {
                userPictureElement.src = currentProfile.pictureUrl;
            } else {
                userPictureElement.alt = "画像なし";
            }
        } catch (profileError) {
            console.error("Failed to get profile for display after GAS error", profileError);
            userNameElement.textContent = '取得失敗';
            userIdElement.textContent = '取得失敗';
            userPictureElement.alt = '取得失敗';
        }
      }
    }

    initializeLiff();
  </script>
</body>
</html>
