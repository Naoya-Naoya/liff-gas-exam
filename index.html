<!DOCTYPE html>
<html>
<head>
  <meta charset="utf-8">
  <meta name="viewport" content="width=device-width, initial-scale=1, maximum-scale=1, user-scalable=0">
  <title>LIFF GAS Test App</title>
  <link rel="icon" href="data:image/svg+xml,<svg xmlns='http://www.w3.org/2000/svg' viewBox='0 0 100 100'><text y='.9em' font-size='90'>ğŸ“±</text></svg>">
  <script src="https://static.line-scdn.net/liff/edge/2/sdk.js"></script>
</head>
<body>
  <h1>LIFF GAS Test</h1>
  <p id="gasResult">GASã‹ã‚‰ã®ãƒ¡ãƒƒã‚»ãƒ¼ã‚¸:</p>
  <p>ãƒ¦ãƒ¼ã‚¶ãƒ¼å: <span id="userName">æœªå–å¾—</span></p>
  <p>ãƒ¦ãƒ¼ã‚¶ãƒ¼ID: <span id="userId">æœªå–å¾—</span></p>
  <p>ãƒ—ãƒ­ãƒ•ã‚£ãƒ¼ãƒ«ç”»åƒ: <img id="userPicture" width="50" height="50" alt="ãƒ—ãƒ­ãƒ•ã‚£ãƒ¼ãƒ«ç”»åƒ"></p>
  
  <script>
    async function initializeLiff() {
      try {
        console.log('LIFFåˆæœŸåŒ–é–‹å§‹...');
        await liff.init({ liffId: "2007507724-jxmBZwP0" });
        console.log('LIFFåˆæœŸåŒ–å®Œäº†');
        
        if (!liff.isLoggedIn()) {
          console.log('ãƒ­ã‚°ã‚¤ãƒ³ãŒå¿…è¦ã§ã™');
          liff.login();
        } else {
          console.log('ãƒ­ã‚°ã‚¤ãƒ³æ¸ˆã¿ã€ãƒ—ãƒ­ãƒ•ã‚£ãƒ¼ãƒ«é€ä¿¡é–‹å§‹');
          await sendProfileToGas();
        }
      } catch (e) {
        console.error("LIFF initialization failed", e);
        document.getElementById('gasResult').textContent = 'LIFFåˆæœŸåŒ–ã‚¨ãƒ©ãƒ¼: ' + e.message;
      }
    }

    async function sendProfileToGas() {
      const gasUrl = "https://script.google.com/macros/s/AKfycbw2OHWupU4jRihx6aih5Ys3TJaMnvmcdNVPlNbKyudofRF0YkKZDvMhdnQBAoLwYnji/exec";
      const gasResultElement = document.getElementById('gasResult');
      const userNameElement = document.getElementById('userName');
      const userIdElement = document.getElementById('userId');
      const userPictureElement = document.getElementById('userPicture');

      try {
        console.log('ãƒ—ãƒ­ãƒ•ã‚£ãƒ¼ãƒ«å–å¾—é–‹å§‹...');
        const profile = await liff.getProfile();
        console.log('ãƒ—ãƒ­ãƒ•ã‚£ãƒ¼ãƒ«å–å¾—å®Œäº†:', profile);
        
        const displayName = profile.displayName;
        const userId = profile.userId;
        const pictureUrl = profile.pictureUrl;

        // ãƒšãƒ¼ã‚¸ã«ãƒ¦ãƒ¼ã‚¶ãƒ¼æƒ…å ±ã‚’è¡¨ç¤º
        userNameElement.textContent = displayName;
        userIdElement.textContent = userId;
        if (pictureUrl) {
          userPictureElement.src = pictureUrl;
          userPictureElement.alt = "ãƒ—ãƒ­ãƒ•ã‚£ãƒ¼ãƒ«ç”»åƒ";
        } else {
          userPictureElement.alt = "ç”»åƒãªã—";
        }

        // GASã«é€ä¿¡ã™ã‚‹ãƒ‡ãƒ¼ã‚¿ã‚’ä½œæˆ
        const dataToSend = {
          type: "profileData",
          displayName: displayName,
          userId: userId,
          pictureUrl: pictureUrl
        };

        console.log('GASã¸ã®ãƒ‡ãƒ¼ã‚¿é€ä¿¡é–‹å§‹...', dataToSend);

        // GASã¸POSTãƒªã‚¯ã‚¨ã‚¹ãƒˆã‚’é€ä¿¡ï¼ˆã‚ˆã‚Šè©³ç´°ãªã‚¨ãƒ©ãƒ¼ãƒãƒ³ãƒ‰ãƒªãƒ³ã‚°ä»˜ãï¼‰
        const response = await fetch(gasUrl, {
          method: 'POST',
          headers: {
            'Content-Type': 'application/json',
            'Accept': 'text/plain'
          },
          body: JSON.stringify(dataToSend),
          mode: 'cors' // æ˜ç¤ºçš„ã«CORSãƒ¢ãƒ¼ãƒ‰ã‚’æŒ‡å®š
        });

        console.log('ãƒ¬ã‚¹ãƒãƒ³ã‚¹å—ä¿¡:', response.status, response.statusText);

        if (!response.ok) {
          const errorText = await response.text();
          throw new Error(`HTTP error! status: ${response.status} - ${response.statusText}. Response: ${errorText}`);
        }

        const gasResponseText = await response.text();
        console.log('GASã‹ã‚‰ã®ãƒ¬ã‚¹ãƒãƒ³ã‚¹:', gasResponseText);
        gasResultElement.textContent = 'GASã‹ã‚‰ã®ãƒ¡ãƒƒã‚»ãƒ¼ã‚¸: ' + gasResponseText;

      } catch (e) {
        console.error("Failed to send profile to GAS", e);
        gasResultElement.textContent = 'GASã¸ã®ãƒ‡ãƒ¼ã‚¿é€ä¿¡ã‚¨ãƒ©ãƒ¼: ' + e.message;
        
        // ã‚¨ãƒ©ãƒ¼æ™‚ã‚‚ãƒ—ãƒ­ãƒ•ã‚£ãƒ¼ãƒ«æƒ…å ±ã¯è¡¨ç¤ºã™ã‚‹
        try {
          if (liff.isLoggedIn()) {
            const fallbackProfile = await liff.getProfile();
            userNameElement.textContent = fallbackProfile.displayName || 'å–å¾—å¤±æ•—';
            userIdElement.textContent = fallbackProfile.userId || 'å–å¾—å¤±æ•—';
            if (fallbackProfile.pictureUrl) {
              userPictureElement.src = fallbackProfile.pictureUrl;
            }
          }
        } catch (profileError) {
          console.error("Failed to get profile for display after GAS error", profileError);
          userNameElement.textContent = 'å–å¾—å¤±æ•—';
          userIdElement.textContent = 'å–å¾—å¤±æ•—';
        }
      }
    }

    // ãƒšãƒ¼ã‚¸èª­ã¿è¾¼ã¿æ™‚ã«åˆæœŸåŒ–
    document.addEventListener('DOMContentLoaded', function() {
      console.log('DOMèª­ã¿è¾¼ã¿å®Œäº†ã€LIFFåˆæœŸåŒ–é–‹å§‹');
      initializeLiff();
    });
  </script>
</body>
</html>
