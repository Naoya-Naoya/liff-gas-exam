<!DOCTYPE html>
<html>
<head>
  <meta charset="utf-8">
  <meta name="viewport" content="width=device-width, initial-scale=1, maximum-scale=1, user-scalable=0">
  <title>LIFF GAS Test App</title>
  <link rel="icon" href="data:image/svg+xml,<svg xmlns='http://www.w3.org/2000/svg' viewBox='0 0 100 100'><text y='.9em' font-size='90'>📱</text></svg>">
  <script src="https://static.line-scdn.net/liff/edge/2/sdk.js"></script>
</head>
<body>
  <h1>LIFF GAS Test</h1>
  <p id="gasResult">GASからのメッセージ:</p>
  <p>ユーザー名: <span id="userName">未取得</span></p>
  <p>ユーザーID: <span id="userId">未取得</span></p>
  <p>プロフィール画像: <img id="userPicture" width="50" height="50" alt="プロフィール画像"></p>
  
  <script>
    async function initializeLiff() {
      try {
        console.log('LIFF初期化開始...');
        await liff.init({ liffId: "2007507724-jxmBZwP0" });
        console.log('LIFF初期化完了');
        
        if (!liff.isLoggedIn()) {
          console.log('ログインが必要です');
          liff.login();
        } else {
          console.log('ログイン済み、プロフィール送信開始');
          await sendProfileToGas();
        }
      } catch (e) {
        console.error("LIFF initialization failed", e);
        document.getElementById('gasResult').textContent = 'LIFF初期化エラー: ' + e.message;
      }
    }

    async function sendProfileToGas() {
      const gasUrl = "https://script.google.com/macros/s/AKfycbw2OHWupU4jRihx6aih5Ys3TJaMnvmcdNVPlNbKyudofRF0YkKZDvMhdnQBAoLwYnji/exec";
      const gasResultElement = document.getElementById('gasResult');
      const userNameElement = document.getElementById('userName');
      const userIdElement = document.getElementById('userId');
      const userPictureElement = document.getElementById('userPicture');

      try {
        console.log('プロフィール取得開始...');
        const profile = await liff.getProfile();
        console.log('プロフィール取得完了:', profile);
        
        const displayName = profile.displayName;
        const userId = profile.userId;
        const pictureUrl = profile.pictureUrl;

        // ページにユーザー情報を表示
        userNameElement.textContent = displayName;
        userIdElement.textContent = userId;
        if (pictureUrl) {
          userPictureElement.src = pictureUrl;
          userPictureElement.alt = "プロフィール画像";
        } else {
          userPictureElement.alt = "画像なし";
        }

        // GASに送信するデータを作成
        const dataToSend = {
          type: "profileData",
          displayName: displayName,
          userId: userId,
          pictureUrl: pictureUrl
        };

        console.log('GASへのデータ送信開始...', dataToSend);

        // GASへPOSTリクエストを送信（より詳細なエラーハンドリング付き）
        const response = await fetch(gasUrl, {
          method: 'POST',
          headers: {
            'Content-Type': 'application/json',
            'Accept': 'text/plain'
          },
          body: JSON.stringify(dataToSend),
          mode: 'cors' // 明示的にCORSモードを指定
        });

        console.log('レスポンス受信:', response.status, response.statusText);

        if (!response.ok) {
          const errorText = await response.text();
          throw new Error(`HTTP error! status: ${response.status} - ${response.statusText}. Response: ${errorText}`);
        }

        const gasResponseText = await response.text();
        console.log('GASからのレスポンス:', gasResponseText);
        gasResultElement.textContent = 'GASからのメッセージ: ' + gasResponseText;

      } catch (e) {
        console.error("Failed to send profile to GAS", e);
        gasResultElement.textContent = 'GASへのデータ送信エラー: ' + e.message;
        
        // エラー時もプロフィール情報は表示する
        try {
          if (liff.isLoggedIn()) {
            const fallbackProfile = await liff.getProfile();
            userNameElement.textContent = fallbackProfile.displayName || '取得失敗';
            userIdElement.textContent = fallbackProfile.userId || '取得失敗';
            if (fallbackProfile.pictureUrl) {
              userPictureElement.src = fallbackProfile.pictureUrl;
            }
          }
        } catch (profileError) {
          console.error("Failed to get profile for display after GAS error", profileError);
          userNameElement.textContent = '取得失敗';
          userIdElement.textContent = '取得失敗';
        }
      }
    }

    // ページ読み込み時に初期化
    document.addEventListener('DOMContentLoaded', function() {
      console.log('DOM読み込み完了、LIFF初期化開始');
      initializeLiff();
    });
  </script>
</body>
</html>
